#!/command/with-contenv bashio

# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at https://mozilla.org/MPL/2.0/.

readonly EXIT_CODE_CONTAINER=$(</run/s6-linux-init-container-results/exitcode)
EXIT_CODE_SERVICE="${1}"
EXIT_CODE_SIGNAL="${2}"
readonly SERVICE="clo"

# Workaround for control channel errors since clo exits with code 0
# even when errors occur: https://github.com/ermakus/cloudpub/issues/2
if [[ "${EXIT_CODE_SERVICE}" -eq 0 ]]; then
  readonly LOG_FILE="/root/.cache/cloudpub/client.log"
  if grep -q "Control channel error" "${LOG_FILE}" 2>/dev/null; then
    bashio::log.error "Обнаружена ошибка: Control channel error."
    EXIT_CODE_SERVICE=1
  fi
fi

bashio::log.info "Сервис ${SERVICE} завершил работу с кодом ${EXIT_CODE_SERVICE} (сигнал: ${EXIT_CODE_SIGNAL})"

# Handle exit codes
if [[ "${EXIT_CODE_SERVICE}" -eq 256 ]]; then
  if [[ "${EXIT_CODE_CONTAINER}" -eq 0 ]]; then
    echo $((128 + EXIT_CODE_SIGNAL)) > /run/s6-linux-init-container-results/exitcode
  fi
  [[ "${EXIT_CODE_SIGNAL}" -eq 15 ]] && exec /run/s6/basedir/bin/halt
elif [[ "${EXIT_CODE_SERVICE}" -ne 0 ]]; then
  if [[ "${EXIT_CODE_CONTAINER}" -eq 0 ]]; then
    echo "${EXIT_CODE_SERVICE}" > /run/s6-linux-init-container-results/exitcode
  fi
  exec /run/s6/basedir/bin/halt
fi
