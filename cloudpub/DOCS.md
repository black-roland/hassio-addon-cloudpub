# Документация для аддона CloudPub

## Настройка

### Получение токена

Токен (API-ключ) можно получить в [панели управления CloudPub](https://cloudpub.ru/dashboard/) в разделе «Привяжите приложение к аккаунту». Вы можете скопировать как сам токен, так и всю команду `./clo set token <токен>` целиком.

### Конфигурация аддона

Основные параметры конфигурации:

| Параметр    | Обязательное? | Описание                                                                     |
|-------------|---------------|------------------------------------------------------------------------------|
| Токен       | Да            | API-ключ CloudPub (можно ввести как сам токен, так и команду с токеном).     |
| Публикации  | Да            | Список сервисов для публикации.                                              |
| Логирование | Нет           | Уровень логирования клиента (`info`, `debug`, `error`). По умолчанию `info`. |

Структура публикаций:

```yaml
- name: name  # Опционально: читаемое имя (латиница, без спецсимволов)
  type: service_type   # Тип сервиса: http, https, tcp, udp, rtsp, rdp, vnc или 1c
  local_addr: address  # Локальный адрес в формате IP:порт или hostname:порт
```

Пример полной конфигурации:

```yaml
token: 7Ml…Ly4 # или просто "./clo set token 7Ml…Ly4"
clo_log_level: info
services:
  - name: homeassistant
    type: http
    local_addr: homeassistant:8123
  - name: mqtt
    type: tcp
    local_addr: core-mosquitto:1883 # в примере используется порт без поддержки SSL
  - name: router
    type: http
    local_addr: 192.168.1.1:80 # IP-адрес и порт веб-интерфейса роутера может отличаться
```

> [!TIP]
> Если вы используете аддон CloudPub впервые, то лучше начать с минимальной конфигурации: оставьте только `homeassistant`.

### Конфигурация Home Assistant

Поскольку Home Assistant по умолчанию блокирует запросы от прокси-серверов, добавьте следующие строки в `configuration.yaml`, чтобы разрешить клиенту CloudPub доступ к вашему Home Assistant:

```yaml
http:
  use_x_forwarded_for: true
  trusted_proxies:
    - 172.30.33.0/24
```

Файл `configuration.yaml` можно отредактировать через аддон File Editor (устанавливается в разделе [Настройки → Дополнения](https://my.home-assistant.io/create-link/?redirect=supervisor_store)). Если настройки `http` уже были указаны ранее, то просто добавьте в существующий блок параметры `use_x_forwarded_for` и `trusted_proxies`.

> [!NOTE]
> После изменения `configuration.yaml` перезапустите Home Assistant, чтобы применить настройки.

## Использование

После настройки ваш Home Assistant будет доступен через публичный URL, предоставленный CloudPub. Ссылка доступна в журнале аддона. Управление туннелями и просмотр статистики доступны через [веб-интерфейс CloudPub](https://cloudpub.ru/dashboard/).

## Решение проблем

Это неофициальное дополнение для CloudPub. Если вы столкнулись с проблемами при использовании аддона, попробуйте сначала выполнить рекомендации ниже:

### Ошибка `400: Bad Request`

#### Проблема с конфигурацией `trusted_proxies`

Если вы получаете ошибку `400: Bad Request` при попытке открыть ссылку в CloudPub, то возможно, не применилась конфигурация `trusted_proxies`. Убедитесь, что в `configuration.yaml` есть следующие строки:

```yaml
http:
  use_x_forwarded_for: true
  trusted_proxies:
    - 172.30.33.0/24
```

После внесения изменений перезагрузите систему.

#### Отступы в YAML

Если ошибка сохраняется, убедитесь, что `configuration.yaml` правильно структурирован. Особенно важно следить за правильностью отступов в YAML. Для валидации конфига можно использовать:
- Встроенный валидатор Home Assistant (Панель разработчика → YAML → Проверить конфигурацию);
- [Онлайн-валидаторы YAML](https://yamllint.com/);
- [Studio Code Server](https://github.com/hassio-addons/addon-vscode) с плагинами для валидации YAML.

#### Дублирование блока `http`

Пожалуйста, просмотрите конфигурационные файлы Home Assistant:
- Найдите все вхождения `http:`;
- Если их несколько — объедините настройки в один блок;
- Удалите лишние объявления.

### Совместимость с Dataplicity

CloudPub можно использовать совместно с интеграцией Dataplicity. Для этого добавьте `127.0.0.1/32` в `trusted_proxies`:

```yaml
http:
  use_x_forwarded_for: true
  trusted_proxies:
    - 172.30.33.0/24 # доступ для CloudPub и других аддонов
    - 127.0.0.1/32   # для Dataplicity
```

Гипотетически CloudPub и Dataplicity могут конфликтовать. Признаки проблем:
1. Ошибка `400: Bad Request` при обращении к Home Assistant через CloudPub;
2. Ошибка `Received X-Forwarded-For header from an untrusted proxy 172.30.33.x` в журналах.

При появлении таких ошибок рекомендуется удалить Dataplicity.

### Проблемы со стабильностью соединения (клиент зависает, туннели падают)

Если вы столкнулись с частыми обрывами соединения или зависанием клиента CloudPub (ошибки вида `Data channel … not found, dropping data`, `Failed to send data to server`), первым делом **включите отладочные логи**.

### Получение логов для технической поддержки CloudPub

Если вы обратились в техническую поддержку CloudPub, вам с высокой вероятностью потребуется предоставить отладочные логи клиента.

Чтобы включить детальное логирование:

1. Перейдите в настройки аддона на вкладку **Конфигурация**;
2. Измените параметр **Уровень логирования клиента** на **debug**;
3. Сохраните настройки и перезапустите аддон.

Теперь на вкладке **Журнал** будут доступны подробные логи работы клиента CloudPub.

> [!NOTE]
> Аддон запускает `clo` с флагом `--verbose`, поэтому логи клиента дублируются на вкладке **Журнал** и доступны не только в `/root/.cache/cloudpub/client.log`.

### Обратитесь за помощью

Прежде чем обращаться за помощью, попробуйте выполнить базовую диагностику:
1. Перезагрузите систему — может помочь с временными сбоями Supervisor.
2. Проверьте, устанавливаются ли другие аддоны — если нет, то проблема может быть с системой или доступом в интернет.
3. Попробуйте другое интернет-подключение — исключите возможные блокировки.
4. Изучите логи аддона на вкладке **Журнал**, а также [логи Supervisor](https://my.home-assistant.io/redirect/logs/?provider=supervisor).

#### При проблемах с аддоном

- **Предпочтительный способ связи**: задать вопрос в [**GitHub Discussions**](https://github.com/black-roland/hassio-addon-cloudpub/discussions/new?category=support). Этот способ помогает другим пользователям найти решение для похожих проблем.
- **Альтернативный способ**: написать на почту `support@roland.black`.
- **Наименее предпочтительный способ**: написать в [Telegram-чат](https://t.me/mansmarthome/236) (отвечаю со значительной задержкой).

> [!IMPORTANT]
> Пожалуйста, не дублируйте вопрос в нескольких каналах. Я читаю все сообщения, но отвечаю в порядке очереди и приоритетности.

#### При проблемах с сервисом CloudPub
Если вы столкнулись с техническими проблемами, связанными непосредственно с работой сервиса CloudPub (а не аддона), например:
- Обрывы связи;
- Недоступность серверов CloudPub;
- Вопросы по работе веб-интерфейса;
- Проблемы с аккаунтом или тарифами.

Обратитесь в [**официальную поддержку CloudPub**](https://cloudpub.ru/dashboard/support/).

## О версиях аддона

Аддон доступен в двух вариантах:

CloudPub Client
- Стабильная версия;
- [Скачивается из надёжного реестра контейнеров (Cloud.ru)](https://t.me/mansmarthome/305);
- Устанавливается за несколько секунд;
- Проходит базовое тестирование перед релизом.

CloudPub Client (Canary)
- Экспериментальная версия с последними изменениями;
- Собирается локально на вашем домашнем сервере при установке;
- Установка занимает больше времени и может завершиться ошибкой из-за заблокированного GitHub Container Registry;
- Используется для тестирования новых функций и исправлений;
- Canary-версия может быть нестабильной.

Для большинства пользователей рекомендуется устанавливать стабильную версию CloudPub Client. Canary-версия предназначена для тестирования и может помочь в разработке аддона.

Если вы хотите помочь в тестировании и разработке аддона, пожалуйста ознакомьтесь с [CONTRIBUTING.md](https://github.com/black-roland/hassio-addon-cloudpub/blob/master/CONTRIBUTING.md).

## Уведомление

Данный аддон является неофициальным и не связан с CloudPub. CloudPub — это сервис, предоставляемый его разработчиками.

Аддон не является официальным продуктом CloudPub и не поддерживается командой CloudPub. Ответственность за изменения в API CloudPub или возможное прекращение работы сервиса не лежит на разработчике аддона.
